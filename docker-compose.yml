version: "3.4"

# BASE CONFIG: applies to all environments, does not work alone
# See: https://docs.docker.com/compose/extends/

# Extension fields
# See: https://docs.docker.com/compose/compose-file/#extension-fields
x-hubble-image: &hubble-image hubble:0.9

services:
  nginx:
    image: nginx:1.17
    container_name: hubble-nginx
    restart: always
    depends_on:
      - web
    volumes:
      - statics:/home/esawebbadm/static

  web:
    image: *hubble-image
    container_name: hubble
    restart: always
    environment:
      SERVICE_TYPE: "web"
    volumes:
      - statics:/home/esawebbadm/static
    expose:
      - "8000"

  db:
    image: postgres:11
    container_name: esawebb-postgres
    environment:
      POSTGRES_PASSWORD: postgres

  broker:
    image: rabbitmq:3.8.3
    container_name: hubble-broker
    restart: always

  celery:
    image: *hubble-image
    container_name: hubble-celery
    restart: always
    command:
      [
        "celery",
        "--app=spacetelescope",
        "--concurrency=8",
        "--hostname=worker1@%h",
        "--loglevel=INFO",
        "--queues=celery",
        "worker",
      ]
    depends_on:
      - web
      - broker

  flower:
    image: *hubble-image
    container_name: hubble-flower
    restart: always
    # TODO: Change url prefix to /admin/tasks when having nginx proxy
    command:
      [
        "celery",
        "--app=spacetelescope",
        "--concurrency=8",
        "--db=/home/esawebbadm/tmp/flowerdb",
        "--persistent",
        "--port=5555",
        "flower",
      ]
    depends_on:
      - broker
      - web

  beat:
    image: *hubble-image
    container_name: hubble-beat
    restart: always
    command:
      [
        "celery",
        "--app=spacetelescope",
        "--loglevel=INFO",
        "--pidfile=/home/esawebbadm/tmp/beat.pid",
        "beat",
      ]
    depends_on:
      - broker
      - web

volumes:
  statics:
